{% extends "chaoslegion/base.html" %}
{% load markdownify %}
{% block content %}
    
<div id="page"  class="postPage profile">
<div class="subnav">
  <div class="row">
    <div class="large-6 columns" style="//padding-top: 20px;">
      <div class="rank-types">
	<!-- <a> New </a> -->
	<!-- <a> Top </a> -->
	<!-- <a> Comments </a> -->
      </div>
      <!-- <div class="username" /> <a href="/user/"><b>rayalez</b></a> </div> -->
      <!-- <div class="fi-mail usermail"></div>       -->
      <!-- <div class="userkarma">129</div> -->
    </div>
    <!-- <div class="large-6 columns"> -->
    <!--   <div style="float:left;"> -->
    <!-- 	<h2> raymestalez </h2> -->
    <!-- 	<\!-- <a> http://orangemind.io </a> -\-> -->
    <!-- 	<p class="userdata">Karma: 128 | Followers: 32</p> -->
    <!--   </div>	 -->
    <!--   <button class="small button">Subscribe</button> -->
    <!-- </div>     -->
    <div class="large-6 columns">
      <div style="float:right;">
	<!-- <a> Store </a>	 -->
	{% if userprofile.website %}
	<a href="{{userprofile.website}}"> Website </a>
	{% endif %}
	{% if userprofile.about %}
	<a herf="/user/{{userprofile.username}}/about"> About </a>
	{% endif %}

	{% if not userprofile == user %}
	{% if userprofile not in subscribed_to %}	
	<a class="small button usersubscribe" style="padding:10px;margin:0 10px;"
	   href="/user/{{userprofile.username}}/subscribe">
	  Subscribe <span class="subscribers">128</a></button>
	{% else %}
	<a class="small button usersubscribe unsubscribe" style="padding:10px;margin:0 10px;"
	   href="/user/{{userprofile.username}}/unsubscribe">
	  Ubsubscribe <span class="subscribers">128</a></button>
	{% endif %}
	{% endif %}

	<b> {{userprofile.username}} </b>
	<span class="userkarma">{{userprofile.karma}}</span>

	<!-- <a> http://orangemind.io </a> -->
	<!-- <p class="userdata">Karma: 128 | Followers: 32</p> -->
      </div>
    </div>        
  </div>
</div>

  <div class="row">
    <div class="large-12 columns">
      {% for post in posts %}
      <article>
	<!-- Vote -->
	<div class="vote-column">
	  <div class="vote">
	    <a href="/login/"
	       class="fi-arrow-up upvote
		      {% if post in upvoted %}upvoted{% endif %}
                      {% if post in downvoted %}downvoted{% endif %}"
	       id="post-upvote-{{post.id}}"></a>
	    <div class="score"> {{post.score}} </div>
	    <a href="/login/"
	       class="fi-arrow-down downvote
		      {% if post in upvoted %}upvoted{% endif %}
                      {% if post in downvoted %}downvoted{% endif %}"
	       id="post-downvote-{{post.id}}"></a>    
	  </div>
	<!-- Comments -->
	  <div class="post-comments">
	    <span class="fi-comment">
	      <span class="number-of-comments"> 183 </span>
	    </span>			      
	  </div>
	</div>	    	  
	<!-- Post Header -->
	<header class="post-header">
	  <a href="{{ post.get_absolute_url }}">
	    <h1> {{post.title}} </h1>
	  </a>
	  <span class="post-tagline">submitted 14 days ago by <a>{{post.author}}</a></span>
	  <hr />
	</header>
	<!-- Post Body -->
	{{post.body | markdownify | safe }}
	<br/>
	<a href="{{ post.get_absolute_url }}">	read more >>>> </a>
	<div>
      </article>
      {% endfor %}
    </div> <!-- End 12 columns -->
    </div>	 <!-- End row -->



<script>
    $(document).ready(function(){
	// getting csrf token.
	function getCookie(name) {
	    var cookieValue = null;
	    if (document.cookie && document.cookie != '') {
		var cookies = document.cookie.split(';');
		for (var i = 0; i < cookies.length; i++) {
		    var cookie = jQuery.trim(cookies[i]);
		    // Does this cookie string begin with the name we want?
		    if (cookie.substring(0, name.length + 1) == (name + '=')) {
			cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
			break;
		    }
		}
	    }
	    return cookieValue;
	}
	var csrftoken = getCookie('csrftoken');

	// Upvote
	function upvote(postId) {
	    $.ajax({
		type: "POST",
		url: "/upvote/",
		data: {"post-id": postId},
		success: function(){
		    var upvoteLink = $('#post-upvote-'+postId);
		    var downvoteLink = $('#post-downvote-'+postId);		    
		    upvoteLink.addClass('upvoted');
		    downvoteLink.addClass('upvoted');		    
		    var score = upvoteLink.parent().find(".score");
                    var notUpdated = Number(score.html());
                    score.html(notUpdated + 1);
		    upvoteLink.off("click");
		    downvoteLink.off("click");		    
		    upvoteLink.click(function(){ return false;});
		    downvoteLink.click(function(){ return false;});		    
		},
		headers: {
		    'X-CSRFToken': csrftoken
		}
	    });
	    return false;
	}

	// Downvote
	function downvote(postId) {
	    $.ajax({
		type: "POST",
		url: "/downvote/",
		data: {"post-id": postId},
		success: function(){
		    var upvoteLink = $('#post-upvote-'+postId);		    
		    var downvoteLink = $('#post-downvote-'+postId);
		    upvoteLink.addClass('downvoted');		    
		    downvoteLink.addClass('downvoted');
		    var score = downvoteLink.parent().find(".score");
                    var notUpdated = Number(score.html());
                    score.html(notUpdated - 1);
		    upvoteLink.off("click");
		    downvoteLink.off("click");		    
		    upvoteLink.click(function(){ return false;});
		    downvoteLink.click(function(){ return false;});	    		    
		},
		headers: {
		    'X-CSRFToken': csrftoken
		}
	    });
	    return false;
	}
	

	{% if user.is_authenticated %}
	//Connect functions
	$("a.upvote").click(function(){
	    var postId = parseInt(this.id.split("-")[2]);
	    return upvote(postId);
	})
	$("a.downvote").click(function(){
	    var postId = parseInt(this.id.split("-")[2]);
	    return downvote(postId);
	})
	// Disabe voted
	$("a.upvoted").off("click");
	$("a.downvoted").off("click");	
        $("a.upvoted").click(function(){ return false;});
        $("a.downvoted").click(function(){ return false;});	
	{% endif %}
    })
</script>
{% endblock content %}


